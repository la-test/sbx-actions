name: Deploy

on:
  workflow_dispatch:
    inputs:
      key_code:
        description: 'Magic Wormhole key code'
        type: string
        required: true
      mailbox:
        description: 'Mailbox server'
        required: true
        default: wss://mailbox.mw.leastauthority.com/v1
      transit:
        description: 'Transit server'
        required: true
        default: tcp:relay.mw.leastauthority.com:4001

jobs:
  check_cnx:
    name: Check connectivity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3    

      - name: Get ssh key
        # uses: ./.github/actions/magic-wormhole-cli
        # with:
        #   path: ssh_key
        #   code: ${{ inputs.key_code }}
        run: |
          sudo apt-get install netcat magic-wormhole
          wormhole \
          --appid lothar.com/wormhole/text-or-file-xfer \
          --relay-url ${{ inputs.mailbox }} \
          --transit-helper ${{ inputs.transit }} \
          receive \
          --accept-file \
          --output-file ssh_key \
          ${{ inputs.key_code }}

      - name: Check ssh command
        run: |
          eval "$(ssh-agent -s)"
          # cat ssh_key | ./scripts/ssh_loadkey.sh
          ssh-add ssh_key
          ssh-add -L
          ssh -F ./ssh/config debian@vps-33320a1d.vps.ovh.net whoami
