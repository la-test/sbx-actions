name: Deploy

on:
  workflow_dispatch:
    inputs:
      key_code:
        description: 'Magic Wormhole key code'
        type: string
        required: true
      mailbox:
        description: 'Mailbox server'
        required: true
        default: wss://mailbox.mw.leastauthority.com/v1
      transit:
        description: 'Transit server'
        required: true
        default: tcp:relay.mw.leastauthority.com:4001

jobs:
  pre:
    # Verification to be done before the real check
    name: Pre-check
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_flag.outputs.should_skip }}
    steps:
      - name: Skip flag
        id: skip_flag
        uses: fkirc/skip-duplicate-actions@v5
        with:
          concurrent_skipping: 'same_content_newer'
          paths: '["scripts/**", "ssh/**", ".github/workflows/deploy.yml"]'

  main:
    name: Check connectivity
    needs: pre
    if: needs.pre.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3    

      - name: Get ssh key
        # uses: ./.github/actions/magic-wormhole-cli
        # with:
        #   path: ssh_key
        #   mode: 0600
        #   code: ${{ inputs.key_code }}
        run: |
          sudo apt-get install magic-wormhole
          wormhole \
          --relay-url ${{ inputs.mailbox }} \
          --transit-helper ${{ inputs.transit }} \
          receive \
          --accept-file \
          --output-file ssh_key \
          ${{ inputs.key_code }}
          chmod 0600 ssh_key

      - name: Check ssh command
        run: |
          eval "$(ssh-agent -s)"
          ssh-add ssh_key
          ssh-add -L
          ssh -F ./ssh/config debian@vps-33320a1d.vps.ovh.net whoami
