name: Ansible

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/ansible.yml'
      - 'ansible/**'
      - 'docker/ansible*/*'
  pull_request:
    paths:
      - '.github/workflows/ansible.yml'
      - 'ansible/**'
      - 'docker/ansible*/*'
  workflow_dispatch:
    inputs:
      key_code:
        description: 'Magic Wormhole key code'
        type: string
        required: true
      target:
        description: 'Target environment'
        type: choice
        options:
          - 'stage'
          - 'prod'
      mode:
        description: 'Mode'
        type: choice
        options:
          - 'safe'
          - 'fast'
          - 'dry'

jobs:
  ansible:
    name: Ansible
    runs-on: ubuntu-22.04
    env:
      DEPLOYMENT_SSH_KEY: ${{ secrets.DEPLOYMENT_SSH_KEY }}
      DEPLOYMENT_USER: bot-cd
      DEPLOYMENT_TARGET: base-local
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - name: Setup Vagrant
        id: vagrant_setup
        run: |
          PACKAGES="\
          qemu \
          libvirt-daemon-system \
          ebtables \
          libguestfs-tools \
          vagrant-libvirt \
          ruby-fog-libvirt \
          nfs-common \
          nfs-kernel-server \
          "
          # Installed required system packages for Vagrant
          sudo apt-get -q update && \
          sudo apt-get -qq install --no-install-recommends -y ${PACKAGES} && \
          sudo apt-get -q clean
          # Update Vagrant libvirt plugin (should we not stick to the debian one?)
          sudo vagrant plugin install vagrant-libvirt
          # Fix wrong permissions on libvirt socket
          sudo setfacl -m user:$USER:rw /var/run/libvirt/libvirt-sock
          sudo systemctl enable libvirtd
          sudo systemctl start libvirtd
          # Show some info
          vagrant --version

      - name: Cache Vagrant boxes
        id: vagrant_cache
        uses: actions/cache@v2
        with:
          path: ~/.vagrant.d/boxes
          key: ${{ runner.os }}-vagrant-${{ hashFiles('Vagrantfile') }}
          restore-keys: |
            ${{ runner.os }}-vagrant-

      - name: Run vagrant up
        id: vagrant_up
        run: |
          vagrant up --provider=libvirt --no-tty
          # Save the SSH config for later
          vagrant ssh-config | grep -v -E "(User|IdentityFile|IdentitiesOnly)" > vagrant-ssh
          # Show some info
          vagrant global-status

      - name: Load ssh key in agent
        id: ssh_agent
        uses: LeastAuthority/ssh-agent-action@v1
        with:
          private_key: ${{ secrets.DEPLOYMENT_SSH_KEY }}

      - name: Deploy Ansible playbook on Vagrant guest
        id: deploy_target
        run: |
          # Specifying the target revision we want to deploy
          target_rev=$(git log -n 1 --format='format:%H')
          echo "Target revision: ${target_rev}"
          echo -n "${target_rev}" | \
          ssh -T -F vagrant-ssh "${DEPLOYMENT_USER}@${DEPLOYMENT_TARGET}"

      - name: Show some logs from the Vagrant guest
        id: vagrant_guest_logs
        if: always()
        run: |
          vagrant ssh -c "sudo journalctl --no-pager"
