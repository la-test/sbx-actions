name: Integration

on:
  push:
  pull_request:

jobs:
  pre:
    # Verification to be done before the real check
    name: Pre-check
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_flag.outputs.should_skip }}
    steps:
      - name: Skip flag
        id: skip_flag
        uses: fkirc/skip-duplicate-actions@v5
        with:
          concurrent_skipping: 'same_content_newer'
          paths: '["src/**", "scripts/**", "ssh/**", ".github/workflows/integrate.yml"]'

  integrate:
    name: Integrate
    needs: pre
    if: needs.pre.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Get a tmpfs for our secret
        id: tmpfs
        uses: LeastAuthority/mount-tmpfs-action@v1
        with:
          size: 2
          root: '/mnt'

      - name: Prepare test key and server
        id: prepare
        run: |
          # Import private key
          cat <<EOF > "${{ steps.tmpfs.outputs.mnt }}/test_key"
          ${{ secrets.SFTP_IDENTITY }}
          EOF
          # Authorizing pub key
          mkdir ~/.ssh && chmod 0700 ~/.ssh
          ssh-keygen -f "${{ steps.tmpfs.outputs.mnt }}/test_key" -y >> ~/.ssh/authorized_keys
          chmod 0600 ~/.ssh/authorized_keys
          sudo systemctl status sshd || sudo systemctl start sshd

      - name: Cleanup tmpfs
        run: |
          sudo umount "${{ steps.tmpfs.outputs.mnt }}"

      - name: Get an agent ready
        id: agent
        uses: LeastAuthority/ssh-agent-action@v1
        with:
          private_key: ${{ secrets.CID_PRIVATE_KEY }}

      - name: Test ssh connectivity
        id: connect
        run: |
          ssh -a -x -o StrictHostKeyChecking=no $(whoami)@localhost ps -edaf
